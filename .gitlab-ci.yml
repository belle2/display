stages:
  - formatting
  - build
  - documentation

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'main'

default:
  image: node:20
  interruptible: true  # All the jobs can be interrupted by newer pipelines
  before_script:
    # Check for updates and install build-essential
    - apt-get update -y
    - apt-get upgrade -y
    - apt-get install -y build-essential
    # Print the exact versions of node and npm
    - node --version
    - npm --version

formatting:
  stage: formatting
  rules:
    # Run this stage only during pipelines associated to merge requests
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    # Start the job
    - echo "Running job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\"..."
    # Install angular
    - npm install -g @angular/cli@15.2.7
    # Install the dependencies
    - npm ci
    # Run prettier
    - npm run prettier
    # Count how many files have been modified by prettier
    # if any, report what to do and exit with status code 1
    - |
      TOUCHED_FILES=$(git diff --name-only | wc -l)
      if [ "${TOUCHED_FILES}" -ne 0 ]; then
          echo "The following files are not properly formatted:"
          git diff --name-only
          echo "Run locally \`npm run prettier\` and commit the formatted files."
          exit 1
      fi
    # Job successfully completed
    - echo "Successfully completed job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\""

build:
  stage: build
  # Run this job using multiple node images
  image: $IMAGE
  parallel:
    matrix:
      - IMAGE: ['node:16', 'node:18', 'node:20']  # All the images we want to use
  script:
    # Start the job
    - echo "Running job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\"..."
    # Install angular
    - npm install -g @angular/cli@15.2.7
    # Install the dependencies
    - npm ci
    # Build the application
    - npm run build
    # Job successfully completed
    - echo "Successfully completed job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\""

documentation:
  stage: documentation
  artifacts:
    paths:
      - docs/build/
    expire_in: 1 week
    expose_as: 'sphinx documentation'
    when: on_success
  script:
    # Start the job
    - echo "Running job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\"..."
    # Install python3-venv and create a virtual environment
    - apt-get install -y python3-venv
    - python3 -m venv display-env
    - source display-env/bin/activate
    # Install the requirements
    - pip3 install -r requirements-docs.txt
    # Build the documentation
    - sphinx-build docs/source/ docs/build
    # Job successfully completed
    - echo "Successfully completed job \"${CI_JOB_NAME}\" with the image \"${CI_JOB_IMAGE}\""